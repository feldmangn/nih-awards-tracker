{%- comment -%}
  _includes/agency_data.html
  Usage from a page:
    ---
    layout: page
    title: NIH
    permalink: /hhs/nih/
    agency_prefix: nih
    ---
    {% include agency_data.html prefix=page.agency_prefix %}
{%- endcomment -%}

<!-- ========= UI ========= -->
<div class="prose">
  <!-- Top recipients -->
  <div class="card" style="margin-bottom:1rem;">
    <div style="display:flex; align-items:center; gap:.75rem; margin-bottom:.75rem;">
      <button id="tab-all" class="pill active">All recipients</button>
      <button id="tab-sb"  class="pill">Small business / 8(a)</button>
      <label for="topN" style="margin-left:1rem;">Show top N:</label>
      <input id="topN" type="number" value="25" min="1" max="200" style="width:5rem;">
    </div>
    <h2 id="chartTitle" style="margin:0 0 .5rem 0;">Top recipients (by obligated amount)</h2>
    <div id="chart" style="min-height:420px;"></div>
  </div>

  <!-- Geography -->
  <h2>Geography (place of performance)</h2>
  <div style="display:flex; gap:.5rem; align-items:center; margin:.5rem 0 1rem 0;">
    <input id="pscFilter"   placeholder="PSC starts with, e.g. R or 66"    style="padding:.35rem .5rem;">
    <input id="naicsFilter" placeholder="NAICS starts with, e.g. 541"      style="padding:.35rem .5rem;">
    <select id="aggMetric" style="padding:.35rem .5rem;">
      <option value="amount" selected>Total obligated amount</option>
      <option value="count">Award count</option>
    </select>
    <button id="applyFilters" class="pill">Apply</button>
    <button id="clearSelection" class="pill">Clear</button>
    <span id="mapNote" class="muted" style="margin-left:.5rem;"></span>
  </div>

  <div class="row">
    <div class="card" style="flex:2; min-width:420px;">
      <div style="display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; margin-bottom:.75rem;">
        <button id="togglePoints" class="pill">Show recipient points</button>
        <button id="backToUS" class="pill" style="display:none;">‚Üê Back to US</button>
      </div>
      <div id="map" style="height:520px;"></div>
    </div>

    <div class="card" style="flex:1; min-width:320px;">
      <h3 id="stateTitle">Click a state</h3>
      <div id="stateSummary" class="muted" style="margin-bottom:.5rem;"></div>
      <ol id="stateList"></ol>
    </div>
  </div>

  <!-- Recent awards (raw) -->
  <h2 style="margin-top:2rem;">Recent awards (raw)</h2>
  <details id="awardsPanel" class="card" style="padding:0;">
    <summary style="list-style:none; padding:1rem; cursor:pointer; display:flex; align-items:center; gap:.5rem; border-bottom:1px solid #eee;">
      <span class="pill" aria-hidden="true">+</span>
      <strong>Show / hide recent awards</strong>
      <span id="summary" class="muted" style="margin-left:auto;"></span>
    </summary>
    <div style="padding:1rem;">
      <div style="display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; margin-bottom:.5rem;">
        <a id="dlCsv"  class="pill" href="#">Download CSV</a>
        <a id="dlJson" class="pill" href="#">Download JSON</a>
        <button id="showMore" class="pill">Show more rows</button>
      </div>
      <div style="overflow:auto;">
        <table id="awardsTable" class="table" style="min-width:1000px;">
          <thead></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </details>

  <!-- Recent awardees (aggregated) -->
  <h2 style="margin-top:2rem;">Recent awardees (top recipients by total)</h2>
  <div class="card">
    <div id="awardeesSummary" class="muted" style="margin:.5rem 0;"></div>
    <div style="overflow:auto;">
      <table id="awardeesTable" class="table" style="min-width:600px;">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="debug"></div>
</div>

<!-- ========= Libraries (must be before app.js) ========= -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>

<!-- ========= Jekyll baseurl -> JS ========= -->
<script>window.__NIH_BASEURL__ = "{{ site.baseurl }}";</script>

<!-- ========= Build data URLs for THIS agency (before app.js) ========= -->
<script>
  (function () {
    // prefix comes from the include call; default to 'nih' if omitted
    var prefix = "{{ include.prefix | strip | default: 'nih' }}";
    var base   = "{{ '/data/' | relative_url }}";

    // Expose exact file paths for app.js
    window.APP_DATA_URLS = {
      AWARDS:            base + prefix + "_awards_last_90d.csv",
      TOP_RECIP:         base + prefix + "_top_recipients_last_90d.csv",
      TOP_RECIP_ENRICH:  base + prefix + "_top_recipients_last_90d_enriched.csv"
    };

    // Update download links
    var csvA  = document.getElementById('dlCsv');
    var jsonA = document.getElementById('dlJson');
    if (csvA)  csvA.href  = window.APP_DATA_URLS.AWARDS;
    if (jsonA) jsonA.href = base + prefix + "_awards_last_90d.json";
  })();
</script>

<!-- ========= App code (reads window.APP_DATA_URLS) ========= -->
<script src="{{ '/assets/js/app.js' | relative_url }}"></script>
